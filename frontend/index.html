<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTN MoMo Analytics Dashboard</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
    
    <!-- Charts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Enhanced Sidebar -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">MTN</div>
                <div class="brand">MoMo</div>
            </div>
            
            <nav class="nav-menu">
                <a href="#" class="nav-link active" data-section="dashboard">
                    <i class="ri-dashboard-3-line"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#" class="nav-link" data-section="transactions">
                    <i class="ri-exchange-funds-line"></i>
                    <span>Transactions</span>
                </a>
                <a href="#" class="nav-link" data-section="analytics">
                    <i class="ri-bar-chart-box-line"></i>
                    <span>Analytics</span>
                </a>
                <a href="#" class="nav-link" data-section="reports">
                    <i class="ri-file-chart-line"></i>
                    <span>Reports</span>
                </a>
            </nav>
            
            <div class="sidebar-footer">
                <div class="theme-toggle">
                    <input type="checkbox" id="darkModeToggle">
                    <div class="slider"></div>
                    <span class="label">Dark Mode</span>
                </div>
            </div>
        </aside>

        <!-- Enhanced Main Content -->
        <main class="main-content">
            <!-- Enhanced Header -->
            <header class="header">
                <h2>Dashboard</h2>
                <div class="header-actions">
                    <div class="search-bar">
                        <i class="ri-search-line"></i>
                        <input type="search" placeholder="Search transactions...">
                    </div>
                    
                    <!-- Auto-refresh status -->
                    <div class="refresh-status">
                        <span id="autoRefreshStatus">üîÑ Auto-refresh (30s)</span>
                        <span id="lastUpdateTime">Last updated: Never</span>
                        <button class="btn-refresh" onclick="toggleAutoRefresh()" title="Toggle auto-refresh">
                            <i class="ri-refresh-line"></i>
                        </button>
                    </div>
                    
                    <div class="user-profile">
                        <i class="ri-user-line"></i>
                    </div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section active">
                <div class="dashboard-content">
                    <!-- Enhanced Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3><i class="ri-wallet-line"></i>Total Balance</h3>
                            <p id="totalBalance">RWF 5,230,000</p>
                            <div class="change positive">
                                <i class="ri-arrow-up-line"></i>
                                <span>+12.5% from last month</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="ri-exchange-line"></i>Total Transactions</h3>
                            <p id="totalTransactions">1,210</p>
                            <div class="change positive">
                                <i class="ri-arrow-up-line"></i>
                                <span>+8.2% from last month</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="ri-arrow-down-line"></i>Money In</h3>
                            <p id="moneyIn">RWF 3,400,000</p>
                            <div class="change positive">
                                <i class="ri-arrow-up-line"></i>
                                <span>+15.3% from last month</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <h3><i class="ri-arrow-up-line"></i>Money Out</h3>
                            <p id="moneyOut">RWF 1,950,000</p>
                            <div class="change negative">
                                <i class="ri-arrow-down-line"></i>
                                <span>-2.1% from last month</span>
                            </div>
                        </div>
                    </div>

                    <!-- Dashboard Charts Grid -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Transaction Volume Trends</h3>
                                <p>Monthly transaction patterns and growth</p>
                            </div>
                            <div id="transactionsChart" class="chart" style="height:350px;"></div>
                        </div>
                        
                        <div class="chart-card">
                            <div class="chart-header">
                                <h3>Transaction Types Distribution</h3>
                                <p>Breakdown of different transaction categories</p>
                            </div>
                            <div id="transactionTypesChart" class="chart" style="height:350px;"></div>
                        </div>
                    </div>

                    <!-- Recent Transactions Table -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3>Recent Transactions</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary">
                                    <i class="ri-filter-line"></i>
                                    Filter
                                </button>
                                <button class="btn btn-primary" id="exportBtn">
                                    <i class="ri-download-line"></i>
                                    Export
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactionsTable">
                                    <!-- Recent transactions will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div id="transactions-section" class="section">
                <div class="dashboard-content">
                    <!-- Enhanced Filters -->
                    <div class="filters-card">
                        <h3>üîç Filter Transactions</h3>
                        <div class="filters-grid">
                            <div class="filter-group">
                                <label>Transaction Type</label>
                                <select id="typeFilter">
                                    <option value="">All Types</option>
                                    <option value="INCOMING_MONEY">Incoming Money</option>
                                    <option value="PAYMENT">Payment</option>
                                    <option value="TRANSFER">Transfer</option>
                                    <option value="WITHDRAWAL">Withdrawal</option>
                                    <option value="AIRTIME">Airtime</option>
                                    <option value="BUNDLE">Bundle Purchase</option>
                                    <option value="BANK_DEPOSIT">Bank Deposit</option>
                                    <option value="CASH_POWER">Cash Power</option>
                                    <option value="THIRD_PARTY">Third Party</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                            
                            <div class="filter-group">
                                <label>Start Date</label>
                                <input type="date" id="startDate">
                            </div>
                            
                            <div class="filter-group">
                                <label>End Date</label>
                                <input type="date" id="endDate">
                            </div>
                            
                            <div class="filter-group">
                                <label>Min Amount (RWF)</label>
                                <input type="number" id="minAmount" placeholder="0" min="0">
                            </div>
                            
                            <div class="filter-group">
                                <label>Max Amount (RWF)</label>
                                <input type="number" id="maxAmount" placeholder="1000000" min="0">
                            </div>
                        </div>
                        
                        <div class="filter-actions">
                            <button class="btn btn-secondary" id="resetFilters">
                                <i class="ri-refresh-line"></i>
                                Reset Filters
                            </button>
                            <button class="btn btn-primary" id="applyFilters">
                                <i class="ri-search-line"></i>
                                Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- All Transactions Table -->
                    <div class="table-card">
                        <div class="table-header">
                            <h3>üìã All Transactions</h3>
                            <div class="table-actions">
                                <button class="btn btn-primary" onclick="dataManager.exportData('csv')">
                                    <i class="ri-download-line"></i>
                                    Export CSV
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="transactions-table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Transaction ID</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Description</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="allTransactionsTable">
                                    <!-- All transactions will be populated here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="pagination">
                            <div class="pagination-info">
                                Showing 1-10 of 100 transactions
                            </div>
                            <div class="pagination-controls">
                                <!-- Pagination buttons will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div id="analytics-section" class="section">
                <div class="dashboard-content">
                    <!-- Analytics Header -->
                    <div class="analytics-header">
                        <h3>üìä Transaction Analytics</h3>
                        <p>Comprehensive visual insights from your transaction data</p>
                    </div>
                    
                    <!-- Analytics Charts Grid -->
                    <div class="analytics-charts">
                        <!-- Monthly Income vs Expenses Chart -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>üí∞ Monthly Income vs Expenses</h4>
                                <p>Track your financial flow over time</p>
                                <button class="export-chart-btn" data-chart-id="analyticsTransactions">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                            <div id="analyticsTransactionsChart" class="chart" style="height:400px; width: 100%"></div>
                        </div>
                        
                        <!-- Transaction Types Distribution Chart -->
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>üìã Transaction Types Distribution</h4>
                                <p>Breakdown of transaction categories</p>
                                <button class="export-chart-btn" data-chart-id="analyticsTypes">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                            <div id="analyticsTypesChart" class="chart" style="height:400px; width: 100%"></div>
                        </div>
                        
                        <!-- Monthly Trends Chart -->
                        <div class="chart-card full-width">
                            <div class="chart-header">
                                <h4>üìà Monthly Trends Analysis</h4>
                                <p>Transaction count and net amount trends</p>
                                <button class="export-chart-btn" data-chart-id="monthly">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                            <div id="monthlyTrendsChart" class="chart" style="height:450px;"></div>
                        </div>
                        
                        <!-- Hourly Distribution Chart -->
                        <div class="chart-card full-width">
                            <div class="chart-header">
                                <h4>‚è∞ Hourly Transaction Distribution</h4>
                                <p>When you transact most during the day</p>
                                <button class="export-chart-btn" data-chart-id="hourly">
                                    <i class="ri-download-line"></i>
                                </button>
                            </div>
                            <div id="hourlyDistributionChart" class="chart" style="height:350px;"></div>
                        </div>
                    </div>
                    
                    <!-- Analytics Summary Cards -->
                    <div class="analytics-summary">
                        <div class="summary-card">
                            <div class="summary-icon">üèÜ</div>
                            <div class="summary-content">
                                <h4>Most Active Hour</h4>
                                <p id="mostActiveHour">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üíé</div>
                            <div class="summary-content">
                                <h4>Largest Transaction</h4>
                                <p id="largestTransaction">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üìä</div>
                            <div class="summary-content">
                                <h4>Average Daily Transactions</h4>
                                <p id="avgDailyTransactions">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üéØ</div>
                            <div class="summary-content">
                                <h4>Most Common Type</h4>
                                <p id="mostCommonType">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">‚ö°</div>
                            <div class="summary-content">
                                <h4>Success Rate</h4>
                                <p id="successRate">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üí∞</div>
                            <div class="summary-content">
                                <h4>Average Amount</h4>
                                <p id="avgTransactionAmount">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üìà</div>
                            <div class="summary-content">
                                <h4>Growth Rate</h4>
                                <p id="growthRate">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">‚è±Ô∏è</div>
                            <div class="summary-content">
                                <h4>Avg Time Between</h4>
                                <p id="avgTimeBetween">Loading...</p>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon">üìÖ</div>
                            <div class="summary-content">
                                <h4>Busiest Day</h4>
                                <p id="busiestDay">Loading...</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Performance Metrics -->
                    <div class="analytics-card performance-metrics">
                        <div class="chart-header">
                            <h4>üìà Performance Metrics</h4>
                            <p>Key performance indicators for your transactions</p>
                        </div>
                        <div class="metric-grid">
                            <div class="metric-item">
                                <div class="metric-icon">‚úÖ</div>
                                <div class="metric-value" id="performanceSuccessRate">95.2%</div>
                                <div class="metric-label">Success Rate</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon">‚ö°</div>
                                <div class="metric-value" id="avgProcessingTime">2.3s</div>
                                <div class="metric-label">Avg Processing Time</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon">üí∞</div>
                                <div class="metric-value" id="performanceAvgAmount">RWF 12.5K</div>
                                <div class="metric-label">Avg Transaction</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-icon">üìà</div>
                                <div class="metric-value" id="performanceGrowthRate">+15.3%</div>
                                <div class="metric-label">Monthly Growth</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="section">
                <div class="dashboard-content">
                    <div class="analytics-card">
                        <div class="chart-header">
                            <h3>üìÑ Generate Reports</h3>
                            <p>Export detailed transaction reports</p>
                        </div>
                        
                        <div class="reports-grid">
                            <div class="report-card">
                                <div class="report-icon">üìä</div>
                                <h4>Monthly Summary Report</h4>
                                <p>Comprehensive monthly transaction summary with charts and insights</p>
                                <button class="btn btn-primary">
                                    <i class="ri-download-line"></i>
                                    Generate Report
                                </button>
                            </div>
                            
                            <div class="report-card">
                                <div class="report-icon">üí∞</div>
                                <h4>Financial Statement</h4>
                                <p>Detailed financial statement with income, expenses, and balance analysis</p>
                                <button class="btn btn-primary">
                                    <i class="ri-download-line"></i>
                                    Generate Report
                                </button>
                            </div>
                            
                            <div class="report-card">
                                <div class="report-icon">üìà</div>
                                <h4>Transaction Analytics</h4>
                                <p>Advanced analytics report with trends, patterns, and forecasts</p>
                                <button class="btn btn-primary">
                                    <i class="ri-download-line"></i>
                                    Generate Report
                                </button>
                            </div>
                            
                            <div class="report-card">
                                <div class="report-icon">üéØ</div>
                                <h4>Custom Report</h4>
                                <p>Create custom reports with specific date ranges and filters</p>
                                <button class="btn btn-secondary">
                                    <i class="ri-settings-line"></i>
                                    Configure
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Enhanced Modal -->
    <div id="transactionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Transaction Details</h3>
                <button class="btn-close" onclick="closeModal()">
                    <i class="ri-close-line"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="transactionDetails">
                    <!-- Transaction details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal hidden">
        <div style="color: white; text-align: center;">
            <i class="ri-loader-4-line" style="font-size: 3rem; animation: spin 1s linear infinite;"></i>
            <p style="margin-top: 1rem; font-size: 1.2rem;">Loading transactions...</p>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toastContainer" class="toast-container"></div>
    <script>
        // Initialize dark mode before main script loads (keep existing)
        const darkModeToggle = document.getElementById('darkModeToggle');
        const isDarkMode = localStorage.getItem('darkMode') === 'true';
        if (darkModeToggle) darkModeToggle.checked = isDarkMode;
        document.documentElement.classList.toggle('dark', isDarkMode);

        // Enhanced dark mode management
        const themeManager = {
            init() {
                // Initialize theme from localStorage or system preference
                const savedTheme = localStorage.getItem('darkMode');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                // Use saved preference, or fall back to system preference
                const shouldUseDark = savedTheme === 'true' || (savedTheme === null && systemPrefersDark);
                
                this.setTheme(shouldUseDark);
                this.bindToggle();
                this.watchSystemChanges();
            },
            
            setTheme(isDark) {
                // Update global state if it exists
                if (typeof appState !== 'undefined') {
                    appState.darkMode = isDark;
                }
                
                document.documentElement.classList.toggle('dark', isDark);
                
                // Update toggle state
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) {
                    toggle.checked = isDark;
                }
                
                // Save preference
                localStorage.setItem('darkMode', isDark);
                
                // Update charts theme with delay to ensure charts are loaded
                setTimeout(() => {
                    this.updateChartsTheme();
                }, 100);
                
                // Dispatch theme change event for other components
                window.dispatchEvent(new CustomEvent('themeChanged', { detail: { isDark } }));
                
                console.log(`üé® Theme switched to ${isDark ? 'dark' : 'light'} mode`);
            },
            
            bindToggle() {
                const toggle = document.getElementById('darkModeToggle');
                if (toggle) {
                    // Remove existing listeners to prevent duplicates
                    toggle.replaceWith(toggle.cloneNode(true));
                    const newToggle = document.getElementById('darkModeToggle');
                    
                    newToggle.addEventListener('change', (e) => {
                        this.setTheme(e.target.checked);
                        
                        // Show toast notification if utils is available
                        if (typeof utils !== 'undefined' && utils.showToast) {
                            utils.showToast(`${e.target.checked ? 'Dark' : 'Light'} mode enabled`, 'info');
                        }
                    });
                    
                    console.log('‚úÖ Dark mode toggle bound successfully');
                }
            },
            
            watchSystemChanges() {
                // Listen for system theme changes
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                    // Only auto-switch if user hasn't manually set a preference
                    const savedTheme = localStorage.getItem('darkMode');
                    if (savedTheme === null) {
                        console.log(`üñ•Ô∏è System theme changed to ${e.matches ? 'dark' : 'light'}`);
                        this.setTheme(e.matches);
                    }
                });
            },
            
            updateChartsTheme() {
                // Check if chart manager and charts exist
                if (typeof chartManager === 'undefined' || 
                    typeof appState === 'undefined' || 
                    !appState.charts) {
                    return;
                }
                
                const isDark = document.documentElement.classList.contains('dark');
                
                const chartTheme = {
                    backgroundColor: isDark ? '#1e293b' : '#ffffff',
                    textStyle: {
                        color: isDark ? '#f8fafc' : '#374151'
                    },
                    title: {
                        textStyle: {
                            color: isDark ? '#f8fafc' : '#374151'
                        }
                    },
                    legend: {
                        textStyle: {
                            color: isDark ? '#cbd5e1' : '#6b7280'
                        }
                    },
                    xAxis: {
                        axisLine: {
                            lineStyle: {
                                color: isDark ? '#475569' : '#e5e7eb'
                            }
                        },
                        axisLabel: {
                            color: isDark ? '#cbd5e1' : '#6b7280'
                        }
                    },
                    yAxis: {
                        axisLine: {
                            lineStyle: {
                                color: isDark ? '#475569' : '#e5e7eb'
                            }
                        },
                        axisLabel: {
                            color: isDark ? '#cbd5e1' : '#6b7280'
                        },
                        splitLine: {
                            lineStyle: {
                                color: isDark ? '#334155' : '#f3f4f6'
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: isDark ? '#334155' : '#ffffff',
                        borderColor: isDark ? '#475569' : '#e5e7eb',
                        textStyle: {
                            color: isDark ? '#f8fafc' : '#374151'
                        }
                    }
                };
                
                // Apply theme to all charts
                try {
                    Object.values(appState.charts).forEach(chart => {
                        if (chart && typeof chart.setOption === 'function') {
                            chart.setOption(chartTheme, true);
                        }
                    });
                    
                    console.log('üé® Charts theme updated successfully');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not update charts theme:', error);
                }
            },
            
            toggle() {
                const currentTheme = document.documentElement.classList.contains('dark');
                this.setTheme(!currentTheme);
            }
        };

        // Global theme toggle function
        function toggleTheme() {
            themeManager.toggle();
        }

        // Initialize theme manager when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                themeManager.init();
            });
        } else {
            themeManager.init();
        }

        // Listen for theme changes from other components
        window.addEventListener('themeChanged', (e) => {
            console.log('üì° Theme change event received:', e.detail);
        });
    </script>
    
    <!-- Load other scripts -->
    <script src="reports.js"></script>
    <script src="dashboard.js"></script>
    <script src="app.js"></script>
</body>
</html>